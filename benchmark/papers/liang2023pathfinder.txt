Deep learning supported discovery of biomarkers for clinical prognosis of liver cancer

Junhao Liang, Weisheng Zhang, Jianghui Yang, Meilong Wu, Qionghai Dai, Hongfang Yin, Ying Xiao & Lingjie Kong 
Nature Machine Intelligence volume 5, pages 408–420 (2023)Cite this article

10k Accesses
34 Citations
39 Altmetric
Metrics details

A preprint version of the article is available at bioRxiv.
Abstract
Tissue biomarkers are crucial for cancer diagnosis, prognosis assessment and treatment planning. However, there are few known biomarkers that are robust enough to show true analytical and clinical value. Deep learning (DL)-based computational pathology can be used as a strategy to predict survival, but the limited interpretability and generalizability prevent acceptance in clinical practice. Here we present an interpretable human-centric DL-guided framework called PathFinder (Pathological-biomarker-finder) that can help pathologists to discover new tissue biomarkers from well-performing DL models. By combining sparse multi-class tissue spatial distribution information of whole slide images with attribution methods, PathFinder can achieve localization, characterization and verification of potential biomarkers, while guaranteeing state-of-the-art prognostic performance. Using PathFinder, we discovered that spatial distribution of necrosis in liver cancer, a long-neglected factor, has a strong relationship with patient prognosis. We therefore proposed two clinically independent indicators, including necrosis area fraction and tumour necrosis distribution, for practical prognosis, and verified their potential in clinical prognosis according to criteria derived from the Reporting Recommendations for Tumor Marker Prognostic Studies. Our work demonstrates a successful example of introducing DL into clinical practice in a knowledge discovery way, and the approach may be adopted in identifying biomarkers in various cancer types and modalities.

Similar content being viewed by others

From whole-slide image to biomarker prediction: end-to-end weakly supervised deep learning in computational pathology

Article 16 September 2024

Deep learning in cancer pathology: a new generation of clinical biomarkers

Article Open access
18 November 2020

Deep learning-based image analysis predicts PD-L1 status from H&E-stained histopathology images in breast cancer

Article Open access
08 November 2022
Main
Pathological analysis of whole slide images (WSIs) is the gold standard for cancer diagnosis and prognosis. Tumour classification, staging and prognosis are assessed according to tissue biomarkers on WSIs1,2. Unfortunately, even though various tissue biomarkers have been proposed, few of them are robust with high sensitivity and specificity3,4. Thus there is still a desperate need for identifying additional robust biomarkers to guide tumour diagnosis and prognosis, and to direct the research of tumour mechanism5,6,7. Specifically in cancer prognosis, with the advancement of computational pathology in recent years, deep learning (DL) models based on end-to-end training can predict a risk score that outperforms current clinical staging, showing the potential of learning knowledge from current medical data8,9,10,11,12. However, due to limited interpretability and generalizability, DL-based risk score is still difficult to be accepted as a useful biomarker for clinical prognosis6,13,14.

Considering that clinicians are likely to keep playing the central role in patient care, it is essential to focus the development and evaluation of artificial intelligence (AI)-based clinical algorithms on their potential to augment rather than replace human intelligence15,16,17. Although some studies have attempted to use established biomarkers and attribution methods to verify the credibility of abstract risk scores8,9,10,11, this strategy fails in generating new knowledge for clinical prognosis. Knowledge discovery based on AI, especially the discovery of new or dominant prognostic biomarkers of clear pathological significance and explicit mathematical model, will open up new direction of human-centric AI for cancer prognosis.

Different from that in the fields of genetics where biologically informed sparse DL models combined with attribution methods has been used to guide pre-clinical discovery18, identifying tissue biomarkers from well-performing prognostic DL models is challenging8,9,10,11,12. On the one hand, the input multi-dimensional images of WSIs for prognosis are of high information density compared with molecular data inputs, which are usually one-dimensional vector and have specific labels or descriptions18. Thus it is difficult to build a sparse network while guaranteeing the prognostic performance19. On the other hand, current attribution methods usually achieve a two-dimensional attribution map for spatial attribution positioning13,14, which is far from locating specific high-attribution features in high-information-density input. These two problems lead to insufficient interpretation, as low-dimensional attribution knowledge is used to interpret abstract results based on high-dimensional inputs. Even worse, it makes one use pre-existing knowledge in explanation, which contradicts the aim of discovering new biomarkers19,20,21.

Histologically, gigapixel WSIs can be regarded as self-multimodal information sources with both slide-level macro mode and region-level micro mode14. The former contains multi-class tissue spatial distribution and interaction information, while the latter contains cell texture and structure information (Methods and Extended Data Fig. 1). However, limited by graphics processing units memory and deep neural network architecture, WSIs are generally cut into patches and only the micro mode information is paid attention to in most DL-based studies9,10,22,23,24. Moreover, in clinics, due to the lack of precise quantification of WSIs, the relationship between tissue spatial distribution and patients’ prognostic result is still not clear.

In this Article, we propose an interpretable, human-centric, DL framework, named PathFinder, that uses the sparse multi-class tissue spatial distribution information of WSIs for assessing prognosis and discovering new biomarkers. Using the macro mode of WSIs, which is of low information density that perfectly matches current spatial-positioning attribution methods, PathFinder can achieve state-of-the-art prognostic performance. Inspired by the exact and intuitive attribution maps of PathFinder, we found spatial distribution of necrosis in liver, a common but overlooked pathological morphology, has a strong relationship with patients’ prognosis, on the basis of which we characterized two significant indicators for clinical prognosis.

Interpretable AI-based framework for biomarker discovery
Figure 1 shows the workflow of PathFinder. It consists of three parts: macro mode acquiring, prognostic deep neural network training and new biomarker discovery. We first trained the multi-class tissue segmentation network PaSegNet to obtain the multi-class tissue probability heat maps as the macro mode of WSIs (Methods). To acquire high-quality macro mode, we proposed meta-annotation, a data-centric annotation method that combined with pathological priors to bridge the gap between current pathological annotation methods and DL training requirements, and achieved efficient, high diversity and low similarity class-balanced training dataset (Methods and Extended Data Fig. 2). With the macro mode of WSIs, we built MacroNet for high-precision prognosis, which is composed of a convolution feature extractor and a multilayer perceptron with a batch normalize layer25 (Methods). Using only time-to-event patient death information as the input mode label and Cox proportional likelihood loss as the network loss, the MacroNet can learn to predict the patients’ risk score on the basis of macro mode only. Then we used attribution methods on the trained MacroNet to acquire the attribution map of input image26, and overlapped the attribution map on the corresponding multi-class segmentation map. The generated two-dimensional attribution map shows the spatial areas that MacroNet focuses on, which matches well with the sparse multi-class tissue spatial distribution information, making the interpretation more direct and objective. On the basis of integrative analysis of macro mode and attribution map, pathologists can propose the hypothesis of the biomarkers that the model is concerned with, followed by quantitatively characterization. The new biomarkers, whose visualizations are similar with the corresponding attribution map, were used as indicators to perform multivariate analysis according to criteria derived from the Reporting Recommendations for Tumor Marker Prognostic Studies27. After testing with clinical dataset, new biomarkers of significantly independent prognostic effect were discovered.

Fig. 1: The workflow of PathFinder.
figure 1
Digitized high-resolution histology slides of patients serve as the input into the framework. The WSI is first processed with PaSegNet, a convolutional neural network (CNN), to obtain the spatial distribution probability heat maps of seven common liver tissues. The achieved macro mode and the corresponding survival time are used as the image–label pair to train the MacroNet, a prognostic CNN with the output of corresponding risk score for guiding the patient’s prognosis. Then one can apply the attribution method to the trained, well-performing MacroNet to explore the model’s spatial focus area, from which to get the inspiration of potential prognostic biomarkers. Following that, these hypothetical biomarkers are modelled on the basis of the macro mode to achieve quantification and characterization, in which the ones similar to the attribution map after visualization are selected as candidate biomarkers and used as indicators for multivariate analysis. After testing with clinical dataset, the significantly independent prognostic indicators can be identified.

Full size image

With PathFinder, we performed the discovery of new tissue biomarkers for clinical prognosis of hepatocellular carcinoma (HCC), which is the fourth leading cause of cancer-related death worldwide28. In this study, we collected 342 WSIs from 330 patient samples in The Cancer Genome Atlas Liver Hepatocellular Carcinoma dataset (TCGA dataset) and 1,182 WSIs from 83 patient samples in Beijing Tsinghua Changgung Hospital dataset (QHCG dataset) (Extended Data Fig. 3 and Supplementary Fig. 1). As for the case that there are multiple WSIs for a patient, we selected the one with the largest tumour fraction as the patient’s representative WSI, as discussed later. We trained MacroNet in a ten-fold cross-validation on TCGA dataset, and tested the generalization of the trained model on the QHCG dataset. To better compare the prognostic performance of MacroNet, we also designed and trained MicroNet and M2MNet for prognosis task. The former one is based on micro mode, which takes high-resolution tumour patches as inputs, and the latter one is based on both macro mode and micro mode, which attempts to fuse these two modes (Methods and Extended Data Fig. 4).

Evaluation of model performance
We first evaluated the multi-class classification performance of PaSegNet on the internal test set of QHCG dataset and external independent test sets including TCGA dataset and Pathology AI Platform 2019 challenge dataset (PAIP dataset). Confusion matrices and receiver operating characteristic (ROC) curves are used to demonstrate classification results (Fig. 2a and Supplementary Figs. 2 and 3). The macro-average accuracy and area under the curve (AUC) are selected to evaluate model performance. Across all test sets, PaSegNet achieved accuracy of 0.948, 0.956 and 0.941, and AUC of 0.9980, 0.9984 and 0.9974, on QHCG, TCGA and PAIP test set, respectively. The results show that the PaSegNet trained on the meta-annotated dataset can achieve accurate multi-class tissue classification. To evaluate the segmentation performance of WSIs, we further visualized the multi-class tissue probability heat maps and segmentation maps obtained by PaSegNet, both of which demonstrate that the model can accurately and smoothly segment WSIs and identify small key lesion areas (Extended Data Fig. 5). In general, PaSegNet trained on the meta-annotation dataset can efficiently quantify WSIs’ macro mode and ensure the following prognostic network training.

Fig. 2: Performance of PathFinder in the discovery of new tissue biomarkers for clinical prognosis of HCC.
figure 2
a, ROC curves for the multi-class tissue classification, evaluated on the internal test set (QHCG) and external independent test sets (TCGA, PAIP). The central measure of the CIs is the median. b, C-Index distribution of MacroNet, MicroNet and M2MNet on TCGA dataset in a ten-fold cross-validation (n = 10 independent experiments for MacroNet, MicroNet and M2Mnet, respectively). Box plot whiskers extend to the smallest and largest value within 1.5 times the interquartile ranges of hinges, and box centre and hinges indicate median and first and third quartiles, respectively. c, C-Index performance of MacroNet, MicroNet and M2MNet on QHCG test set (n = 83 patients). The data are presented as mean values, and the error bars show the 95% CI of the mean estimate (1,000 bootstrapping samples). d, Kaplan–Meier analysis of patient stratification of clinical staging patients on TCGA dataset. e,g, Kaplan–Meier analysis of patient stratification of low- and high-risk patients via MacroNet on TCGA dataset (e) and QHCG dataset (g), respectively. f,h, Multivariable analysis of factors associated with overall survival and MacroNet risk score on TCGA dataset (n = 330 patients) (f) and QHCG dataset (n = 83 patients) (h), respectively; the data are presented as HR estimates (squares), and the error bars show the 95% CI of the HR estimate, according to multivariable Cox proportional hazards model; the results of univariate and multivariate analyses are described in details in Supplementary Tables 1 and 2. P values according to two-sided Mann–Whitney–Wilcoxon test (b), two-sided two-sample t-test (c), two-sided log-rank test (d, e, and g) and multivariable Cox proportional hazards model (f and h). n, sample size; Stage, AJCC staging; TIL, tumour infiltrating lymphocytes digital score; BDT, bile duct thrombosis; AFP, alpha-fetoprotein; MVI, microvascular invasion.

Source data

Full size image

We next evaluated the prognostic capability of MacroNet, MicroNet and M2MNet, by using ten-fold cross-validation on TCGA dataset. To compare the performance of prognostic networks, we used the median of cross-validated concordance index (C-Index) to measure the predictive accuracy of each model, Kaplan–Meier curves to visualize the quality of patient stratification between predicted high-risk and low-risk patients, and the log-rank test to test the statistical difference between high-risk and low-risk groups (Supplementary Note 1). MacroNet achieved a C-Index of 0.708, similar to the C-Index 0.717 using MicroNet and lower than the C-Index 0.787 using M2MNet (Fig. 2b). In visualizing the Kaplan–Meier survival curves of predicted high-risk and low-risk patient groups, MacroNet also showed good discrimination between the two risk groups (P = 1.25 × 10−7) compared with M2MNet and clinical staging (Fig. 2d,e and Extended Data Fig. 6a). In addition, we also reported dynamic area under the curve (AUC; termed as Survival AUC) to measure the prognostic performance of the networks. Similar conclusion can be achieved as MacroNet achieved the Survival AUC of 0.732, similar to the Survival AUC 0.729 using MicroNet and lower than the Survival AUC 0.832 using M2MNet (Supplementary Fig. 4a).

We further evaluated the models’ generalization capability by training the models on TCGA dataset and testing them on QHCG dataset. MacroNet achieved a C-Index of 0.754, whereas M2MNet and MicroNet achieved C-Indices of 0.695 and 0.652, respectively (Fig. 2c). On Survival AUC, we observed similar model performances, with MacroNet reaching an AUC of 0.796 compared with 0.733 in M2MNet and 0.666 in MicroNet (Supplementary Fig. 4b). These results demonstrated that MacroNet has stronger generalization ability in prognosis. In addition, the Kaplan–Meier survival curves of MacroNet showed good discrimination between two risk groups (P = 7.68 × 10−7) on QHCG dataset, as M2MNet did (Fig. 2g and Extended Data Fig. 6b). Furthermore, the multivariable analysis revealed that the risk score predicted by MacroNet (hazard ratio (HR) 2.21, 95% confidence interval (CI) 1.26 to 3.86, P = 0.0057, TCGA dataset; HR 6.56, 95% CI 2.01 to 21.36, P = 0.0018, QHCG dataset) was independent of other clinicopathological characteristics (Fig. 2f,h and Supplementary Tables 1 and 2), and the risk scores generated by MicroNet and M2MNet were also independent of other clinicopathological characteristics (Supplementary Tables 3–6). These results indicate that MacroNet can achieve state-of-the-art prognostic performance using only macro mode of WSIs and has potential in finding useful prognostic biomarkers.

Discovery, characterization and verification of biomarkers
To interpret why MacroNet can achieve high-performance prognosis and to explore which macro features largely contribute to risk score, we conducted an integrated analysis from both global and individual perspectives. We counted the difference in the tissue fractions in patients of high-risk scores and low-risk scores from a global perspective, and found that the necrosis fraction is significantly higher in the high-risk score group (Extended Data Fig. 7a,c). Then we analysed the segmentation map of high-risk and low-risk WSIs, and observed that necrosis occurred in every high-risk WSI, but not in all low-risk WSIs (Fig. 3a). From an individual perspective, we used the attribute method to locate the areas where MacroNet focused on in the form of a two-dimensional heat map, and overlapped the result with the segmentation map for better visualization (Fig. 1). We discovered that the areas of high contribution are almost the junctions of necrosis and other tissues (Fig. 3b), which is consistent with our former conclusions obtained from the global perspective. All the discoveries inspired us that spatial distribution of necrosis may have a strong relationship with HCC prognosis.

Fig. 3: Discovery and characterization of new tissue biomarkers.
figure 3
a, Segmentation maps of low- and high-risk WSIs predicted by MacroNet on TCGA dataset and QHCG dataset. b, Attribution heat maps of WSI segmentation maps and their corresponding visualization results of NEC and TND hypothetical indicators.

Full size image

To make the DL-based MacroNet acceptable in clinical practice, we proposed two hypotheses of new biomarkers, namely necrosis area fraction in WSIs (NEC) and tumour necrosis distribution (TND), based on above integrated analyses and inspirations of MacroNet. We first established mathematical models of these two indicators to characterize them, and achieved their quantification based on the existing macro mode (Methods). By visualizing these two indicators and comparing them with the corresponding attribution map, we found that these two hypothetical indicators can well characterize the features that MacroNet pays attention to (Fig. 3b and Extended Data Fig. 8), indicating that these two clinically available indicators are of great potential to affect the prognosis of the risk score given by MacroNet. It also should be noted that these biomarkers are objective and universal pathological features, considering that NEC is a common and inherent attribute of WSIs, and TND is a newly designed indicator that takes into account the spatial distribution and interaction between tumour and necrosis.

To verify whether NEC and TND are independent prognostic indicators, we investigated the prognostic significance of these two indicators on both TCGA and QHCG datasets using Kaplan–Meier curves and Cox hazard analysis by conducting univariate and multivariate analyses of clinicopathological parameters. Additionally, to compare the performance with new clinical indicators inspired by AI, we quantified tumour-infiltrating lymphocytes (TILs), which is already known as a prognostic factor and is significantly different between high-risk group and low-risk group (Extended Data Fig. 7b,d and Methods)12,29, as an indicator designed on the basis of known clinical experience. The Kaplan–Meier curves and P values based on log-rank test showed that NEC and TND can significantly distinguish high-risk and low-risk groups on both TCGA and QHCG datasets (Fig. 4a,c,e,g). The univariate and multivariable analyses revealed that the dependences of overall survival on NEC (HR 4.66, 95% CI 1.77 to 12.28, P = 0.0019, QHCG dataset; HR 1.80, 95% CI 1.13 to 2.87, P = 0.0133, TCGA dataset) and TND (HR 6.67, 95% CI 2.36 to 18.85, P = 0.0003, QHCG dataset; HR 3.00, 95% CI 1.56 to 5.74, P = 0.0009, TCGA dataset) were more significant than most clinical indicators including TILs (Fig. 4b,d,f,h). This suggests that the two indicators are independent of other clinicopathological characteristics. In addition, NEC (HR 3.31, 95% CI 1.73 to 6.30, P = 0.0003) and TND (HR 2.92, 95% CI 1.52 to 5.60, P = 0.0012) can even be used as significant indicators in recurrence prediction (Extended Data Figs. 6c–i and Supplementary Table 9). It is worth noting that the Cox’s proportional hazard model was able to achieve a C-Index 0.7 without utilizing additionally clinical variables or risk score predicted by DL methods, as it makes predictions based on only NEC (C-Index 0.703) or TND (C-Index 0.691) (Fig. 5d,e). In addition, taking other clinical factors together into consideration, the C-Indices of NEC and TND can be further improved to 0.831 and 0.845, indicating the value of these two indicators in clinical prognosis (Supplementary Fig. 5).

Fig. 4: Verification of new tissue biomarkers.
figure 4
a,c, Kaplan–Meier analysis of patient stratification of low (low TND score) and high-risk (high TND score) patients on TCGA dataset (a) and QHCG dataset (c). b,d, Multivariable analyses of TND and other factors associated with overall survival on TCGA dataset (b) (n = 330 patients) and QHCG dataset (d) (n = 83 patients). e,g, Kaplan–Meier analysis of patient stratification of low (low NEC score) and high-risk (high NEC score) patients on TCGA dataset (e) and QHCG dataset (g). f,h, Multivariable analyses of NEC and other factors associated with overall survival on TCGA dataset (f) (n = 330 patients) and QHCG dataset (h) (n = 83 patients). In b, d, f and h, the data are presented as HR estimates (squares) and the error bars show the 95% CI of the HR estimate, according to multivariable Cox proportional hazards model; details are presented in Supplementary Tables 7 and 8. P values according to two-sided log-rank test (a, c, e and g) and multivariable Cox proportional hazards model (b, d, f and h). n, sample size; Stage, AJCC staging; TIL, tumour infiltrating lymphocytes digital score; BDT, bile duct thrombosis; AFP, alpha-fetoprotein; MVI, microvascular invasion.

Source data

Full size image

Fig. 5: Exploring the robustness of macro mode indicators.
figure 5
a, Sampling strategy of clinical WSIs. NLP, non-neoplastic liver parenchyma; TC, tumour centre; TI, tumour–liver interface; ANL, adjacent non-neoplastic liver; RNL, remote non-neoplastic liver. b, Deviations in the risk scores predicted by MacroNet from different WSIs of a patient. The risk scores of all WSIs (excluded WSIs without tumour) of 83 patients are ranked in ascending order based on the selected WSI points. Each patient has more than one WSIs points (blue points on a specific abscissa), in which the selected WSIs to characterize the patient’s final risk score is labelled as red points. c–e, Random selection strategy simulations of MacroNet risk score (c), NEC (d), and TND (e), respectively. The red dotted lines represent C-Indices of MacroNet risk score, NEC, and TND under the largest tumour fraction selection rule. Each blue point represents the C-Index of one random selection simulation, and all the blue points are ranked in ascending order based on their C-Indices. The distribution of these points with respect to the C-Index is shown on the right side of the image.

Source data

Full size image

Overall, the above results verified spatial distribution of necrosis as a new biomarker for prognosis. We demonstrated that the prognostic performance of the AI inspired indicators based on WSIs macro mode is comparable to the performances of various DL models based on WSIs micro mode, genomics and multimodality9,10,11,12.

Robustness of macro mode indicators
In clinical practice, there are generally many WSIs with different sampling positions from a patient (Fig. 5a). As the micro mode is not greatly affected by the sampling locations, the prognostic DL models trained on the micro mode rarely discuss the situation where a patient has multiple WSIs8. However, different sampling positions will cause huge differences in the macro mode, which will lead to deviations in the risk scores predicted by MacroNet (Fig. 5b and Extended Data Figs. 7e,f). Exploring how to select representative WSI from multiple WSIs of a patient becomes an unavoidable problem in applying macro indicators in clinical prognosis.

In our former study, we selected the largest tumour fraction one as the patient’s representative WSI. To explore the robustness and effectiveness of this selection rule in clinical prognosis, we calculated the risk score, TND and NEC of all WSIs, and randomly selected one from the multiple WSIs of a patient as the representative WSI, with C-Index being used to measure the accuracy of prognosis under this random sampling standard. After 10,000 simulations under random selection strategy, the prognostic performance of our former selection rule is better than most random selections (Fig. 5c,d,e). Even for NEC and TND, two objective and universal biomarkers, the results based on largest tumour fraction selection rule were better than 94% of the results based on random selection rule, indicating that the largest tumour fraction selection rule can be adopted with NEC and TND biomarkers for clinical prognosis.

Besides, it is important to verify the prognostic robustness of these two indicators calculated from segmentation maps with different accuracies. We first calculated the TND and NEC scores corresponding to the segmentation maps generated by 11 commonly used convolutional neural networks (CNNs) (Extended Data Figs. 9 and 10, Supplementary Note 2 and Supplementary Figs. 6 and 7). Then we measured the corresponding prognostic performance (that is, C-Index) of NEC and TND scores. No major difference was found in the TND and NEC scores calculated from segmentation results generated by different CNNs of the same patient, and the overall trend of score ranking remains relatively consistent across all patients (Extended Data Figs. 9a and 10a). More specifically, except for AlexNet that has poor classification performance, the C-Indices of TND (Extended Data Figs. 9b,c) and NEC (Extended Data Figs. 10b,c) obtained from segmentation maps generated by other CNNs are close. These indicate the robustness of these two indicators on prognosis, which further illustrates their generalization ability and usability in clinical practice.

Discussion
We present PathFinder as a complete framework of AI-inspired discovery of clinically acceptable biomarkers. Instead of using DL to predict a risk score from WSIs8,9,10,11,24, we focus on proposing human-centric workflows for inspiring pathologists to discover new clinically acceptable biomarkers from well-performing black boxes. We show a method of bridging AI and clinical prognosis, and prove the potential of AI in learning and exploring new prognostic biomarkers based on large datasets and objective survival information.

To overcome the limited interpretability and generalizability of DL-based risk scores, we proposed to simplify the input of DL models and explored the relationship between multi-class tissue spatial distribution and prognosis. Different from utilizing pre-trained networks to compress WSIs8,10,24,30, our input is more sparse and has explicit medical meaning, which enables the attribution method to characterize the biomarkers that the model focuses on more accurately. Our results show that the prognostic performance of DL is still good even when the input is reduced from WSIs of several gigabytes to macro mode of several megabytes. This indicates that the multi-class tissue spatial distribution of WSIs has prognostic information and the conventional inputs of prognostic DL models are redundant.

In this study, we did not target AI as a substitute for pathologists, but as a tool for pathologists to mine dominate biomarkers. Just as AI guides mathematical intuition31, pathologists can formulate specific hypotheses based on their clinical experience, and then use PathFinder to deeply mine the connection between hypotheses-relevant information and prognosis. Inspired by PathFinder, we defined two necrosis-related clinical prognostic indicators, NEC and TND, and demonstrated their feasibility in HCC prognosis. Even as a common pathological morphology in liver cancer, spatial distribution of necrosis has caught little attention and has not been put into clinical staging guidelines in detail32,33,34. Our findings demonstrate that AI can analyse data more objectively and alert us about missing information. Different from highly diverse tumour tissues, necrosis is easier to be distinguished in both clinics and computer vision, which makes it convenient for clinical prognosis. Meanwhile, the mechanisms between tumour and necrosis are still unclear. The significant effect of TND and NEC on prognosis may suggest that the spatial distribution of tissue is worth considering in researches of necrosis mechanisms. Additionally, tumour necrosis is postulated to be caused by tumour necrosis factors35, which have been found significant correlations with TILs36,37. However, our results suggest a low correlation between tumour necrosis and TILs (Extended Data Figs. 6j,k), indicating that HCC necrosis may have its own specific causes and mechanisms.

As products of knowledge discovery, TND and NEC have clear pathological significance and explicit mathematical model. The strong generalizability of these new biomarkers is evaluated on TCGA and QHCG datasets, suggesting the great advantages of human-centric AI for knowledge discovery and clinical prognosis.

Same as all commonly used DL models, the focusing features of PathFinder would be affected by training data and hyperparameters. In addition, the intra-individual variability of the macro mode cannot be ignored. However, we explored the robustness of macro mode and gave a feasible selection rule for macro mode variability problem.

In PathFinder, the macro mode can achieve state-of-the-art prognostic performance as micro mode does. Considering that numerous studies have achieved multi-class tissue segmentation across various cancer types38,39, further exploration of the impact of these ready-made segmentation maps on prognosis may lead to new discoveries. Moreover, benefitting from its simple and easy-to-use features, PathFinder can be easily migrated to similar tasks such as spatial multi-omics and three-dimensional pathological prognosis to discover new biomarkers in different modalities40,41,42. We expect PathFinder as a fundamental mechanism to better integrate the two fields of clinical prognosis and AI, and inspire more meaningful discoveries.

Methods
Meta-annotation
The acquisition of annotated data is a major challenge for deep-learning-based computational pathology. Recently, annotation-free methods such as multi-instance learning or self-supervised learning have achieved good performance on both WSI segmentation, diagnosis and prognosis22,43. However, these annotation-free approaches usually require a large amount of data and computing power to make up the cost for the lack of existing pathology priors during training. Improving annotation method and/or dataset quality without changing existing supervised learning method may be another means to solve the dilemma44. Here we analysed the gap between pathological annotation and DL, and proposed the meta-annotation based on existing pathological priors and training requirements of DL models to achieve efficient and high-quality pathological image annotation and dataset generation.

The gap between pathological annotation and DL
Conventional WSIs pathological annotation methods usually annotate the contour of specific tissues, for example, tumour boundaries (Extended Data Fig. 2b). However, annotating WSIs is time consuming and laborious due to the complex boundaries and large scale. Furthermore, the tissue boundaries always contain other tissues which are difficult to exclude by annotating (Extended Data Fig. 2d), which would introduce noise label data into the DL training set (Extended Data Fig. 2a). Some of the WSIs regions are completely mixed by multiple tissue types that cannot be annotated precisely (Extended Data Fig. 2e). Moreover, tissue area fractions of different classes in WSIs are quite different, for example, bile duct reaction tissue may occupy 0.01% of the WSI tissue area while tumour tissue occupies 60%. In addition, a tissue type with a large area in one WSI is always similar in content, which is redundant (Extended Data Fig. 2f). Such unbalanced data bring difficulties to DL training (Extended Data Fig. 2a).

However, when it comes to DL, the desired training set is class balanced, has high diversity and has low similarity. Even a small dataset can achieve a high performance if it has such features (Extended Data Fig. 2a). Most segmentation tasks first classify patches and then stitch them together according to their spatial distribution, to acquire the segmentation map of WSI. However, it is difficult to annotate the junction of tissues and give a specific label to the segmented patches from tissue boundary. Meanwhile, according to the pathological priors, most specific tissues on a WSI are actually similar (Extended Data Fig. 2f), and using all specific tissues as the training set will cause serious problems of data imbalance. Therefore, for the segmentation methods based on patches classification, it is not advisable to perform the complete annotation of outer contours to improve the training performance. Designing new annotation methods based on the requirements of DL and the properties of WSI may enable efficient data annotation and good-performance segmentation.

Purpose of meta-annotation
We proposed the meta-annotation to close the gap between conventional WSI pathological annotation and DL training requirements. Meta-annotation method aims to ensure the diversity of annotated tissues while reducing redundant annotation between similar tissues based on WSIs prior and pathologists’ experience. The basic purpose of pathological annotation is to label different classes of tissues, where the classes can be different types of tissues, such as fibrosis and tumour, or different subtypes, such as early-stage tumour and late-stage tumour. In our experiment, we pay attention to seven different types of tissue and empty area (TUM, tumour; Nor, normal; FIB, fibrosis; INF, inflammation; NEC, necrosis; REA, bile duct reaction; STE, steatosis; EMP, empty), and different subtypes of the same tissue (for example, early-stage tumour versus late-stage tumour) are considered as intra-specific diversity9,45,46. The selected seven tissue types are common, which basically cover histological features that are easily identified at the resolution level of current WSIs. On the basis of such classification, we can study macro spatial distributions of multi-class tissue.

Details of meta-annotation
The process of meta-annotation and the acquisition of PaSegNet dataset for segmentation is shown in Extended Data Fig. 2g. For the WSI that needs to be annotated, pathologists use rectangular boxes to annotate typical areas to reduce the difficulty of labelling. For example, for large tumour or normal regions, pathologists only annotate a small region of inside areas, and perform sampling in multiple spatial regions to ensure high diversity and low similarity of the data. For tissue types that occupy only small areas, such as inflammation and bile duct reactions, pathologists use rectangular boxes to enclose their regions as much as possible. After annotating WSIs, non-overlap 150 × 150 pixels patches are extracted automatically on the basis of the annotated rectangular boxes. Although the impact of class imbalance has been minimized in the annotating process, TUM and NOR patches are still much more frequent than REA and INF patches. To overcome this problem, during automatic extraction, we specify that TUM and NOR classes undergo random extraction of up to 100 patches based on rectangular annotations in one WSI, and all annotated regions of other classes are extracted in full patches. After patch extraction, resampling is applied to the extracted dataset to achieve better class balance, which leads to the final meta-annotation training set.

WSI decoupling and sparsification
To overcome the problem of the high information density of WSIs and make prognostic DL model more suitable for current attribution methods, we decoupled the input WSI into macro mode and micro mode. In our study, we selected the multi-class tissue probability heat maps as the macro mode and the morphology of tissue patches as the micro mode of WSIs (Extended Data Fig. 1). We first used OTSU method to remove background47, divided the non-background area into 150 × 150 RGB image patches at 20× magnification, and recorded the locations of all patches. Then we proposed PaSegNet fseg, a ResNeXt50-based multi-class classification CNN25 pre-trained on ImageNet48, to encode the input patch  into probability vector , where  is the location of patch I, pt is the probability of I belonging to class t in eight tissue classes. Specifically, we used the convolution layers fcovn of ResNeXt50 to convert I into 2,048-dimensional feature vector, and modified the last output feature of fully connected layers (ffc) g’s dimension to 8:


(1)

(2)
After training, the PaSegNet can map the input WSI  to macro mode M ∈ ℝ𝑚'×𝑛'×8, , :


(3)
where , ,  is the probability map of class t in eight tissue classes. The class index  of  was selected as:


(4)
and the segmentation map  can be obtained on M by calculating the class index  of each position:


(5)
where  represents the tissue class t of . On the basis of the segmentation map, 16 patches of 512 × 512 RGB images in tumour area were randomly extracted at 20× magnification. For the cases of insufficient tumour area, 16 patches were randomly selected with the highest tumour probability. After colour normalizing49, these patches were combined as the micro mode  of the WSI.

Datasets description
A summary of the selection and study design of the data used in this work is shown in Supplementary Fig. 1 and Extended Data Fig. 3.

Data source
The data used in this work come from two publicly available datasets, TCGA dataset and PAIP dataset, and the in-house dataset of QHCG dataset (Supplementary Fig. 1 and Extended Data Fig. 3a). In the TCGA dataset, there are 342 WSIs of 330 patients, and each WSI has the clinical information correspondingly. In the PAIP dataset, there are 100 WSIs, but no clinical or survival information available. In the QHCG dataset, there are 1,182 WSIs of 83 patients with clinical information and 151 external WSIs without clinical information. In this study, all WSIs were processed at 20× magnification.

Datasets for WSI segmentation
The training set for segmentation was obtained by meta-annotation on the 151 WSIs with no clinical information of QHCG dataset. The extracted training set had 40,000 patches for each class. The test sets were composed of an internal test set and an external test set to characterize the classification performance and generalization ability of the trained model. The internal test set was randomly annotated by pathologists in QHCG’s 1,182 WSIs that were not included in the training set and were not from a same patient, and each class had 550 patches. The external test sets contained TCGA test set and PAIP test set, from which 200 patches per class were randomly extracted, separately.

Datasets for prognosis
A total of 1,182 WSIs from 83 clinically informative patients in QHCG dataset and 342 WSIs from 330 patients in TCGA dataset were used to train and test the prognostic network. The macro mode obtained by WSI decoupling and the patients’ survival information constituted the MacroNet prognosis dataset; the micro mode obtained by WSI decoupling and the patients’ survival information constituted the MicroNet prognosis dataset. Macro mode, micro mode and patients’ survival information constituted the multimodal M2MNet prognostic dataset. The data were split randomly during cross-validation.

DL network architecture
Considering that the macro mode on prognosis has not been explored, while it may have advantages in being easy to interpret with attribution methods, we designed MicroNet, MacroNet and M2MNet, to test whether the performance of macro mode on prognosis can be comparable to that based on tumour cell morphology (micro mode), and whether the combination of tumour cell morphology and spatial distribution information is helpful for prognosis. A summary of network architectures is shown in Extended Data Fig. 4.

MacroNet
To perform survival prediction from macro mode of WSIs, we extended ResNeXt50 to learn the representation feature vector of macro mode and give corresponding risk score by receiving multi-channel sparse macro mode and making survival regression. The MacroNet  can be described by three components, the macro mode encoding module , the feature compression and stabilization module , and the prediction module . Specifically, we modified the input channel number of ResNeXt50 to 8 to match channel number of sparse macro mode M. The modified convolution layers were selected as macro mode encoding module  to encode M into a more compact 2,048-dimensional feature space by extracting the information of multi-class spatial distribution and interaction. To further compress the encoded macro feature vector  to macro mode representation  and improve the robustness of network, a fully connected layer (FC) followed by batch normalization (BN) and rectified linear unit (ReLU) constructed feature compression and stabilization module . Then the final patient-level risk score  was computed from  using , a fully connected layer with weights  and survival loss function (described in detail in ‘Loss function’). The whole model is shown in the equations below:


(6)

(7)

(8)
MicroNet
To perform survival prediction from micro mode of WSIs, we extended ResNeXt50 to learn the representation feature vector of micro mode and give corresponding risk score by receiving multi-channel micro mode and making survival regression. The MicroNet can be described by three components, the micro mode encoding module , the feature compression and stabilization module , and the prediction module . Specifically, we modified the input channel number of ResNeXt50 to 48 to match channel number of micro mode C. The modified convolution layers were selected as macro mode encoding module  to encode C into a more compact 2,048-dimensional feature space by extracting the information of micro morphology. Feature compression and stabilization module  was used to further compress the encoded micro feature vector  to micro mode representation  and improve the robustness of network. Then the final patient-level risk score  was computed from  using . The whole model is shown in the equations below:


(9)

(10)

(11)
M2MNet
To achieve multimodal survival prediction from both macro mode and micro mode, MacroNet and MicroNet were used to extract macro mode representation  and micro mode representation . Following the unimodal feature representations, multimodal feature representation  was obtained by concatenating  and . To integrate the unimodal feature representations more comprehensively, a fusion module  was designed to first use a fully connected layer expand  to a 1,024-dimensional fusion feature space and then use feature compression and stabilization module with the prediction module  make survival prediction.


(12)

(13)

(14)

(15)
Loss function
To perform survival prediction for both unimodal and multimodal networks, we selected the negative Cox partial log-likelihood as the loss function50. Let the survival function  be the probability of a patient surviving longer than time t0, where T is a continuous random variable that represents patient survival time, the hazard function that describes probability that an event occurs instantaneously at a time t (after t0) can be written as:


(16)
and the survival function  is the integration of the hazard function  over the time between t and :


(17)
Assuming that the hazard function can be parameterized as an exponential linear function, Cox proportional hazards model makes a semi-parametric approach for estimating the hazard function:


(18)
where  is the baseline hazard that describes how the risk of an event changes over time, β is model parameters vector that describes how the hazard varies with features vector  of patient i. On the basis of the Cox proportional hazards model, the negative Cox partial log-likelihood is as follows:


(19)
where U is the set of uncensored patients,  is the set of patients whose time of death or last follow-up  is later than patient i. In this loss function,  can be regarded as the risk score given by , where β is the weights of  and  is the feature vector of patient i input into . To train MacroNet, MicroNet and M2MNet for survival prediction, we used the negative Cox partial log-likelihood combined with deep networks as loss function, with the derivative of the loss function used as error during back-propagation.

Training details
MacroNet and MicroNet were trained end-to-end with a mini-batch size of 64, using Adam optimization with a learning rate of 5 × 10−3, b1 coefficient of 0.9, b2 coefficient of 0.999 and L2 weight decay of 4 × 10−4. M2MNet was trained end-to-end with a mini-batch size of 32, using Adam optimization with a learning rate of 1 × 10−3, b1 coefficient of 0.9, b2 coefficient of 0.999 and L2 weight decay of 4 × 10−4. To mitigate model overfitting during training, we also added a L1 regularization term with weight 3 × 10−4 to the loss function and used dropout layers with P = 0.25 during M2MNet training.

Attribution methods
To explore the good-performance prognostic model , we used attribution techniques to find features or structures that are relevant to the prediction made by , which may guide us to discover new biomarkers. There are many attribution techniques to achieve such work, including gradient-based methods51, feature occlusion and attention weights methods52. However, most current attribution techniques can only give attribution maps to achieve two-dimensional contribution spatial location, which may be insufficient to interpret the high-information-density input.

To overcome this problem and explore the relationship between macro mode and prognosis, we decoupled input WSIs into sparse macro mode and trained high-performance MacroNet. The macro mode, which only has tissue spatial distribution and interaction information, matches well with the attribution maps produced by current attribution techniques, and the extremely sparse and explicit information of macro mode makes the interpretation more objective and accurate. In this work, we used saliency maps, which were generated by calculating the gradient of the loss function for risk score with respect to the input pixels26, combined with segmentation maps of WSIs to achieve interpretation. For better visualization, we made the transparency corresponding to the first 30% of the values in the generated saliency map increasing linearly, and overlapped the saliency map with corresponding segmentation map. The discovered features can then be useful for guiding hypotheses for new biomarkers.

Quantification of WSI macro mode
Tissue fraction
On the basis of the segmentation map S, the tissue fraction of class t in seven tissue classes (exclude empty) can be written as:


(20)
where  is the number of pixels belong to class t in S,  is the number of empty pixels in S and N is the number of all pixels in S.

TIL
TILs have been shown to be a key prognostic indicator for a range of cancers12. We quantified TILs on the basis of segmentation map S and TIL abundance (TILAb) score29. Specifically, S was divided into m × n equal sized grids, and the grid size was selected as ten pixels in our work. Then the co-localization score M in terms of the Morisita–Horn index is defined as53


(21)
where  and  represent the percentage of inflammation and tumour regions in the  grid-cell, respectively. Considering the inflammatory proliferation in tumour as a good prognostic indicator for patient survival, the quantified TILs can be written as:


(22)
NEC and TND
To characterize and verify that NEC and TND were prognostic biomarkers, we built their mathematical models based on S. For NEC, we used the tissue fraction model to quantify it:


(23)
where  is the number of pixels belong to necrosis in S.

TIL quantifies the spatial distribution and the interaction between tumour and inflammation to characterize TILs, whereas TND is used to quantify the spatial intersection of tumour boundaries and necrosis boundaries, which is essentially the spatial distribution and interaction between tumour and necrosis, to characterize high attribution areas for MacroNet prognosis.

Therefore, we modified TIL into TND by changing  into the percentage of necrosis regions in the  grid-cell :


(24)

(25)
Computational hardware and software
Python (version 3.7.9) packages used by the project include PyTorch (version 1.8.0), Lifelines (version 0.25.11), NumPy (version 1.19.2), Pandas (version 1.2.2), Albumentations (version 0.5.2), OpenCV (version 4.5.1), Pillow (version 7.2.0) and OpenSlide (version 1.1.2). All WSIs were processed on Intel Xeon multi-core central processing units and a total of four Nvidia 3090 graphics processing units. DL models were trained with Nvidia software CUDA 11.1 and cuDNN 8.0.5. Saliency was implemented using Captum (version 0.2.0) (ref. 54). Statistical analyses such as two-sample t-tests used implementations from SciPy (version 1.4.1), and log-rank tests and univariable and multivariable analyses used implementations from Lifelines (version 0.25.11). Plotting and visualization packages were generated using Seaborn (version 0.9.0) and Matplotlib (version 3.1.1).

Reporting summary
Further information on research design is available in the Nature Portfolio Reporting Summary linked to this article.

Data availability
The TCGA diagnostic whole-slide data and corresponding clinical information are available from NIH genomic data commons (https://portal.gdc.cancer.gov/projects/TCGA-LIHC). The PAIP histology data and corresponding annotations are available from the Pathology AI Platform 2019 challenge (https://paip2019.grand-challenge.org/Dataset/). Restrictions apply to the availability of the QHCG data, including WSIs and generated PaSegNet dataset, which were used with institutional permission through institutional review board approval for the current study, and are thus not publicly available. Please email all requests for academic use of raw and processed data to the corresponding author. All requests will be evaluated on the basis of institutional and departmental policies to determine whether the data requested are subject to intellectual property or patient privacy obligations. Data can only be shared for non-commercial academic purposes and will require a formal material transfer agreement. Source data are provided with this paper.

Code availability
All code was implemented in Python using PyTorch as the primary DL package. All code and scripts to reproduce the experiments of this paper are available at https://github.com/Biooptics2021/PathFinder. The code is also available at https://zenodo.org/record/7628549 (ref. 55).